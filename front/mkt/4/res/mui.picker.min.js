/**
 * 选择列表插件
 * varstion 2.0.0
 * by Houfeng
 * Houfeng@DCloud.io
 **/
!function(e,t,i,n){var r=e.rad2deg=function(e){return e/(Math.PI/180)},a=(e.deg2rad=function(e){return e*(Math.PI/180)},navigator.platform.toLowerCase()),s=navigator.userAgent.toLowerCase(),l=(s.indexOf("iphone")>-1||s.indexOf("ipad")>-1||s.indexOf("ipod")>-1)&&(a.indexOf("iphone")>-1||a.indexOf("ipad")>-1||a.indexOf("ipod")>-1),o=e.Picker=function(e,t){var i=this;i.holder=e,i.options=t||{},i.init(),i.initInertiaParams(),i.calcElementItemPostion(!0),i.bindEvent()};o.prototype.findElementItems=function(){var e=this;return e.elementItems=[].slice.call(e.holder.querySelectorAll("li")),e.elementItems},o.prototype.init=function(){var e=this;e.list=e.holder.querySelector("ul"),e.findElementItems(),e.height=e.holder.offsetHeight,e.r=e.height/2-10,e.d=2*e.r,e.itemHeight=e.elementItems.length>0?e.elementItems[0].offsetHeight:40,e.itemAngle=parseInt(e.calcAngle(.8*e.itemHeight)),e.hightlightRange=e.itemAngle/2,e.visibleRange=90,e.beginAngle=0,e.beginExceed=e.beginAngle-30,e.list.angle=e.beginAngle,l&&(e.list.style.webkitTransformOrigin="center center "+e.r+"px")},o.prototype.calcElementItemPostion=function(e){var t=this;e&&(t.items=[]),t.elementItems.forEach(function(i){var n=t.elementItems.indexOf(i);if(t.endAngle=t.itemAngle*n,i.angle=t.endAngle,i.style.webkitTransformOrigin="center center -"+t.r+"px",i.style.webkitTransform="translateZ("+t.r+"px) rotateX("+-t.endAngle+"deg)",e){var r={};r.text=i.innerHTML||"",r.value=i.getAttribute("data-value")||r.text,t.items.push(r)}}),t.endExceed=t.endAngle+30,t.calcElementItemVisibility(t.beginAngle)},o.prototype.calcAngle=function(e){var t=this,i=b=parseFloat(t.r);e=Math.abs(e);var n=180*parseInt(e/t.d);e%=t.d;var a=(i*i+b*b-e*e)/(2*i*b);return n+r(Math.acos(a))},o.prototype.calcElementItemVisibility=function(e){var t=this;t.elementItems.forEach(function(i){var n=Math.abs(i.angle-e);n<t.hightlightRange?i.classList.add("highlight"):n<t.visibleRange?(i.classList.add("visible"),i.classList.remove("highlight")):(i.classList.remove("highlight"),i.classList.remove("visible"))})},o.prototype.setAngle=function(e){var t=this;t.list.angle=e,t.list.style.webkitTransform="perspective(1000px) rotateY(0deg) rotateX("+e+"deg)",t.calcElementItemVisibility(e)},o.prototype.bindEvent=function(){var t=this,i=0,n=null,r=!1;t.holder.addEventListener(e.EVENT_START,function(e){r=!0,e.preventDefault(),t.list.style.webkitTransition="",n=(e.changedTouches?e.changedTouches[0]:e).pageY,i=t.list.angle,t.updateInertiaParams(e,!0)},!1),t.holder.addEventListener(e.EVENT_END,function(e){r=!1,e.preventDefault(),t.startInertiaScroll(e)},!1),t.holder.addEventListener(e.EVENT_CANCEL,function(e){r=!1,e.preventDefault(),t.startInertiaScroll(e)},!1),t.holder.addEventListener(e.EVENT_MOVE,function(e){if(r){e.preventDefault();var a=(e.changedTouches?e.changedTouches[0]:e).pageY-n,s=t.calcAngle(a),l=a>0?i-s:i+s;l>t.endExceed&&(l=t.endExceed),l<t.beginExceed&&(l=t.beginExceed),t.setAngle(l),t.updateInertiaParams(e)}},!1),t.list.addEventListener("tap",function(e){elementItem=e.target,"LI"==elementItem.tagName&&t.setSelectedIndex(t.elementItems.indexOf(elementItem),200)},!1)},o.prototype.initInertiaParams=function(){var e=this;e.lastMoveTime=0,e.lastMoveStart=0,e.stopInertiaMove=!1},o.prototype.updateInertiaParams=function(e,t){var i=this,n=e.changedTouches?e.changedTouches[0]:e;if(t)i.lastMoveStart=n.pageY,i.lastMoveTime=e.timeStamp||Date.now(),i.startAngle=i.list.angle;else{var r=e.timeStamp||Date.now();r-i.lastMoveTime>300&&(i.lastMoveTime=r,i.lastMoveStart=n.pageY)}i.stopInertiaMove=!0},o.prototype.startInertiaScroll=function(e){this.find(e.changedTouches[0].target)?mui.signFir=!0:mui.signSec=!0;var t=this,i=e.changedTouches?e.changedTouches[0]:e,n=e.timeStamp||Date.now(),r=(i.pageY-t.lastMoveStart)/(n-t.lastMoveTime),a=r>0?-1:1,s=6e-4*a*-1,l=Math.abs(r/s),o=r*l/2,c=t.list.angle,d=t.calcAngle(o)*a,p=d;return c+d<t.beginExceed&&(l=l*((d=t.beginExceed-c)/p)*.6),c+d>t.endExceed&&(l=l*((d=t.endExceed-c)/p)*.6),0==d?void t.endScroll():void t.scrollDistAngle(n,c,d,l)},o.prototype.find=function(e){return-1!==e.className.indexOf("mui-picker-inner")?-1!==e.className.indexOf("fir"):!!e.parentNode&&this.find(e.parentNode)},o.prototype.scrollDistAngle=function(e,t,i,n){var r=this;r.stopInertiaMove=!1,function(e,t,i,n){var a=n/13,s=0;!function e(){if(!r.stopInertiaMove){var n=r.quartEaseOut(s,t,i,a);return r.setAngle(n),++s>a-1||n<r.beginExceed||n>r.endExceed?void r.endScroll():void setTimeout(e,13)}}()}(0,t,i,n)},o.prototype.quartEaseOut=function(e,t,i,n){return-i*((e=e/n-1)*e*e*e-1)+t},o.prototype.endScroll=function(){var e=this;if(e.list.angle<e.beginAngle)e.list.style.webkitTransition="150ms ease-out",e.setAngle(e.beginAngle);else if(e.list.angle>e.endAngle)e.list.style.webkitTransition="150ms ease-out",e.setAngle(e.endAngle);else{var t=parseInt((e.list.angle/e.itemAngle).toFixed(0));e.list.style.webkitTransition="100ms ease-out",e.setAngle(e.itemAngle*t)}e.triggerChange()},o.prototype.triggerChange=function(t){var i=this,n=i.getSelectedIndex(),r=i.items[n];r&&(!e.trigger||n==i.lastIndex&&!0!==t||e.trigger(i.holder,"change",{index:n,item:r}),i.lastIndex=n,"function"==typeof t&&t(),t||(-1!==i.holder.querySelector(".mui-picker-inner").className.indexOf("fir")?delete mui.signFir:delete mui.signSec)),setTimeout(function(){delete mui.signFir;delete mui.signSec;},1000)},o.prototype.correctAngle=function(e){var t=this;return e<t.beginAngle?t.beginAngle:e>t.endAngle?t.endAngle:e},o.prototype.setItems=function(e){var t=this;t.items=e||[];var i=[];t.items.forEach(function(e){null!=e&&i.push("<li>"+(e.text||e)+"</li>")}),t.list.innerHTML=i.join(""),t.findElementItems(),t.calcElementItemPostion(),t.setAngle(t.correctAngle(t.list.angle)),t.triggerChange(!0)},o.prototype.getItems=function(){return this.items},o.prototype.getSelectedIndex=function(){return parseInt((this.list.angle/this.itemAngle).toFixed(0))},o.prototype.setSelectedIndex=function(e,t,i){var n=this;n.list.style.webkitTransition="";var r=n.correctAngle(n.itemAngle*e);if(t&&t>0){var a=r-n.list.angle;n.scrollDistAngle(Date.now(),n.list.angle,a,t)}else n.setAngle(r);n.triggerChange(i)},o.prototype.getSelectedItem=function(){return this.items[this.getSelectedIndex()]},o.prototype.getSelectedValue=function(){return(this.items[this.getSelectedIndex()]||{}).value},o.prototype.getSelectedText=function(){return(this.items[this.getSelectedIndex()]||{}).text},o.prototype.setSelectedValue=function(e,t,i){var n=this;for(var r in n.items)if(n.items[r].value==e)return void n.setSelectedIndex(r,t,i)},e.fn&&(e.fn.picker=function(e){return this.each(function(t,i){if(!i.picker)if(e)i.picker=new o(i,e);else{var n=i.getAttribute("data-picker-options"),r=n?JSON.parse(n):{};i.picker=new o(i,r)}}),this[0]?this[0].picker:null},e.ready(function(){e(".mui-picker").picker()}))}(window.mui||window,window,document),function(e,t){e.dom=function(i){return"string"!=typeof i?i instanceof Array||i[0]&&i.length?[].slice.call(i):[i]:(e.__create_dom_div__||(e.__create_dom_div__=t.createElement("div")),e.__create_dom_div__.innerHTML=i,[].slice.call(e.__create_dom_div__.childNodes))};var i='<div class="mui-picker">\t\t<div class="mui-picker-inner">\t\t\t<div class="mui-pciker-rule mui-pciker-rule-ft"></div>\t\t\t<ul class="mui-pciker-list">\t\t\t</ul>\t\t\t<div class="mui-pciker-rule mui-pciker-rule-bg"></div>\t\t</div>\t</div>';e.PopPicker=e.Class.extend({init:function(i){var n=this;n.options=i||{},n.options.buttons=n.options.buttons||["取消","确定"],n.panel=e.dom('<div class="mui-poppicker">\t\t<div class="mui-poppicker-header">\t\t\t<button class="mui-btn mui-poppicker-btn-cancel">取消</button>\t\t\t<button class="mui-btn mui-btn-blue mui-poppicker-btn-ok">确定</button>\t\t\t<div class="mui-poppicker-clear"></div>\t\t</div>\t\t<div class="mui-poppicker-body">\t\t</div>\t</div>')[0],t.body.appendChild(n.panel),n.ok=n.panel.querySelector(".mui-poppicker-btn-ok"),n.cancel=n.panel.querySelector(".mui-poppicker-btn-cancel"),n.body=n.panel.querySelector(".mui-poppicker-body"),n.mask=e.createMask(),n.cancel.innerText=n.options.buttons[0],n.ok.innerText=n.options.buttons[1],n.cancel.addEventListener("tap",function(e){n.hide()},!1),n.ok.addEventListener("tap",function(e){if(n.callback&&!mui.signFir&&!mui.signSec){for(var t=n.getSelectedItems(),i=!0,r=0;r<t.length;r++)i=i&&!!t[r].text;if(i)var a=n.callback(n.getSelectedItems());!1!==a&&n.hide()}},!1),n.mask[0].addEventListener("tap",function(){n.hide()},!1),n._createPicker(),n.panel.addEventListener(e.EVENT_START,function(e){e.preventDefault()},!1),n.panel.addEventListener(e.EVENT_MOVE,function(e){e.preventDefault()},!1)},_createPicker:function(){var t=this,n=t.options.layer||1,r=100/n+"%",a="mui-picker-inner fir";t.pickers=[];for(var s=1;n>=s;s++){i=1==s?i.replace("mui-picker-inner",a):i.replace(a,"mui-picker-inner");var l=e.dom(i)[0];l.style.width=r,t.body.appendChild(l);var o=e(l).picker();t.pickers.push(o),l.addEventListener("change",function(e){var t=this.nextSibling;if(t&&t.picker){var i=(e.detail||{}).item||{};t.picker.setItems(i.children)}},!1)}},setData:function(e){e=e||[],this.pickers[0].setItems(e)},getSelectedItems:function(){var e=[];for(var t in this.pickers){var i=this.pickers[t];"object"==typeof i&&e.push(i.getSelectedItem()||{})}return e},show:function(i){var n=this;n.callback=i,n.mask.show(),t.body.classList.add(e.className("poppicker-active-for-page")),n.panel.classList.add(e.className("active")),n.__back=e.back,e.back=function(){n.hide()}},hide:function(){var i=this;i.disposed||(i.panel.classList.remove(e.className("active")),i.mask.close(),t.body.classList.remove(e.className("poppicker-active-for-page")),e.back=i.__back)},dispose:function(){var e=this;e.hide(),setTimeout(function(){for(var t in e.panel.parentNode.removeChild(e.panel),e)e[t]=null,delete e[t];e.disposed=!0},300)}})}(mui,document);